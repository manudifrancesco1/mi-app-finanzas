(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[405],{8312:function(e,t,a){(window.__NEXT_P=window.__NEXT_P||[]).push(["/",function(){return a(6983)}])},5076:function(e,t,a){"use strict";var r=a(5893),n=a(9263),o=a(7294);t.Z=function(e){var t;let{onClose:a,onSaved:l,initial:i}=e,[s,u]=(0,o.useState)(i||{amount:"",date:"",description:"",category_id:void 0}),[c,d]=(0,o.useState)([]),[g,m]=(0,o.useState)(!1),[p,h]=(0,o.useState)(""),f=async()=>{let{data:{user:e},error:t}=await n.O.auth.getUser();if(t||!e){console.error("No hay usuario para cargar categor\xedas:",t);return}let{data:a,error:r}=await n.O.from("categories").select("id, name").eq("user_id",e.id).order("name",{ascending:!0});r?console.error("Error cargando categor\xedas:",r):d(a||[])};(0,o.useEffect)(()=>{f()},[]);let x=async()=>{if(!(null==i?void 0:i.id)||!window.confirm("\xbfEst\xe1s seguro de eliminar este ingreso?"))return;let{error:e}=await n.O.from("incomes").delete().eq("id",i.id);e?(console.error(e),alert("Error al eliminar el ingreso")):l()},v=async e=>{let t;e.preventDefault();let{data:{user:a},error:r}=await n.O.auth.getUser();if(r||!a)return console.error("No se pudo obtener el usuario autenticado:",r),alert("Error interno: no hay usuario autenticado");let o=s.category_id;if(g&&p.trim()){let{error:e}=await n.O.from("categories").insert({name:p.trim(),user_id:a.id});if(e)return console.error("Error al crear categor\xeda:",e),alert("Error al crear categor\xeda");await f();let t=c.find(e=>e.name===p.trim());t?o=t.id:console.warn("Categor\xeda creada pero no encontrada en recarga")}let u={amount:parseFloat(s.amount),date:s.date,description:s.description,category_id:o,user_id:a.id};(null==i?void 0:i.id)?{error:t}=await n.O.from("incomes").update(u).eq("id",i.id):{error:t}=await n.O.from("incomes").insert(u),t?(console.error("Error al guardar ingreso:",t),alert("Error al guardar el ingreso")):l()};return(0,r.jsx)("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50",children:(0,r.jsxs)("div",{className:"bg-white p-6 rounded-lg w-full max-w-md",children:[(0,r.jsx)("h2",{className:"text-xl font-semibold mb-4",children:(null==i?void 0:i.id)?"Editar ingreso":"Nuevo ingreso"}),(0,r.jsxs)("form",{onSubmit:v,className:"space-y-4",children:[(0,r.jsx)("input",{type:"number",step:"0.01",value:s.amount,onChange:e=>u({...s,amount:e.target.value}),placeholder:"Monto",className:"w-full border rounded px-3 py-2",required:!0}),(0,r.jsx)("input",{type:"date",value:s.date,onChange:e=>u({...s,date:e.target.value}),className:"w-full border rounded px-3 py-2",required:!0}),(0,r.jsxs)("select",{value:g?"__new":null!==(t=s.category_id)&&void 0!==t?t:"",onChange:e=>{"__new"===e.target.value?(m(!0),h(""),u({...s,category_id:void 0})):(m(!1),u({...s,category_id:Number(e.target.value)}))},className:"w-full border rounded px-3 py-2",children:[(0,r.jsx)("option",{value:"",children:"– Sin categor\xeda –"}),c.map(e=>(0,r.jsx)("option",{value:e.id,children:e.name},e.id)),(0,r.jsx)("option",{value:"__new",children:"+ Agregar nueva categor\xeda"})]}),g&&(0,r.jsx)("input",{type:"text",value:p,onChange:e=>h(e.target.value),placeholder:"Nombre de nueva categor\xeda",className:"w-full border rounded px-3 py-2",required:!0}),(0,r.jsx)("input",{type:"text",value:s.description,onChange:e=>u({...s,description:e.target.value}),placeholder:"Descripci\xf3n",className:"w-full border rounded px-3 py-2"}),(0,r.jsxs)("div",{className:"flex justify-between mt-6",children:[(null==i?void 0:i.id)&&(0,r.jsx)("button",{type:"button",onClick:x,className:"text-red-600 hover:underline",children:"Eliminar"}),(0,r.jsxs)("div",{className:"flex gap-2 ml-auto",children:[(0,r.jsx)("button",{type:"button",onClick:a,className:"px-4 py-2 rounded bg-gray-200 hover:bg-gray-300",children:"Cancelar"}),(0,r.jsx)("button",{type:"submit",className:"px-4 py-2 rounded bg-green-600 text-white hover:bg-green-700",children:"Guardar"})]})]})]})]})})}},6983:function(e,t,a){"use strict";a.r(t),a.d(t,{default:function(){return g}});var r=a(5893),n=a(1163),o=a(7294),l=a(9263);function i(){let e=(0,n.useRouter)(),t=async()=>{await l.O.auth.signOut(),e.push("/login")};return(0,r.jsx)("button",{onClick:t,className:"fixed top-4 right-4 bg-red-600 text-white px-3 py-1 rounded",children:"Cerrar sesi\xf3n"})}var s=a(8078),u=a(5076);let c=o.forwardRef(function(e,t){let{title:a,titleId:r,...n}=e;return o.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor","aria-hidden":"true","data-slot":"icon",ref:t,"aria-labelledby":r},n),a?o.createElement("title",{id:r},a):null,o.createElement("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M15.75 19.5 8.25 12l7.5-7.5"}))}),d=o.forwardRef(function(e,t){let{title:a,titleId:r,...n}=e;return o.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor","aria-hidden":"true","data-slot":"icon",ref:t,"aria-labelledby":r},n),a?o.createElement("title",{id:r},a):null,o.createElement("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"m8.25 4.5 7.5 7.5-7.5 7.5"}))});var g=()=>{let e=(0,n.useRouter)(),[t,a]=(0,o.useState)(null),[g,m]=(0,o.useState)(!1),[p,h]=(0,o.useState)(()=>{let e=new Date;return"".concat(e.getFullYear(),"-").concat(String(e.getMonth()+1).padStart(2,"0"))}),[f,x]=(0,o.useState)([]),[v,w]=(0,o.useState)(0),[y,b]=(0,o.useState)(0),[j,N]=(0,o.useState)([]),[S,_]=(0,o.useState)(0),[E,C]=(0,o.useState)([]),[O,k]=(0,o.useState)(0),[D,q]=(0,o.useState)({}),[A,F]=(0,o.useState)({}),[M,L]=(0,o.useState)(!1),[R,Y]=(0,o.useState)(!1);return((0,o.useEffect)(()=>{(async()=>{let{data:{session:t}}=await l.O.auth.getSession();t?a(!0):e.replace("/login")})();let{data:t}=l.O.auth.onAuthStateChange((t,a)=>{a||e.replace("/login")});return()=>t.subscription.unsubscribe()},[e]),(0,o.useEffect)(()=>{t&&(async()=>{m(!0);let{data:{session:e}}=await l.O.auth.getSession();if(!e)return;let t=e.user.id,[a,r]=p.split("-").map(Number),n="".concat(a,"-").concat(String(r).padStart(2,"0"),"-01"),o=new Date(a,r,0).getDate(),i="".concat(a,"-").concat(String(r).padStart(2,"0"),"-").concat(o),{data:s}=await l.O.from("incomes").select("category:category_id(name),amount").eq("user_id",t).gte("date",n).lte("date",i),u={};null==s||s.forEach(e=>{var t;let a=e.category,r=Array.isArray(a)?null===(t=a[0])||void 0===t?void 0:t.name:null==a?void 0:a.name;u[r||"–"]=(u[r||"–"]||0)+e.amount});let c=u["Devoluci\xf3n"]||0;delete u["Devoluci\xf3n"];let d=Object.entries(u).map(e=>{let[t,a]=e;return{name:t,total:a}});x(d),w(d.reduce((e,t)=>e+t.total,0)),b(c);let{data:g}=await l.O.from("transactions").select("category:category_id(name),subcategory:subcategory_id(name),amount,expense_mode").eq("user_id",t).gte("date",n).lte("date",i),h={},f={},v={};null==g||g.forEach(e=>{var t,a,r;let n=Array.isArray(e.category)?null===(t=e.category[0])||void 0===t?void 0:t.name:null===(a=e.category)||void 0===a?void 0:a.name;if("fixed"===e.expense_mode)h[n]=(h[n]||0)+e.amount;else{f[n]=(f[n]||0)+e.amount;let t=e.subcategory,a=Array.isArray(t)?null===(r=t[0])||void 0===r?void 0:r.name:null==t?void 0:t.name;a&&(v[n]=v[n]||{},v[n][a]=(v[n][a]||0)+e.amount)}});let y=e=>Object.entries(e).map(e=>{let[t,a]=e;return{name:t,total:a}}),j=y(h);N(j),_(j.reduce((e,t)=>e+t.total,0));let S=y(f);C(S),k(S.reduce((e,t)=>e+t.total,0));let E={};Object.entries(v).forEach(e=>{let[t,a]=e;return E[t]=y(a)}),q(E),m(!1)})()},[p,t]),null===t)?null:(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(i,{}),(0,r.jsxs)("div",{className:"flex flex-wrap items-center justify-center space-x-4 my-4",children:[(0,r.jsx)(c,{className:"h-6 w-6 cursor-pointer text-gray-600",onClick:()=>{let[e,t]=p.split("-").map(Number),a=new Date(e,t-2,1);h("".concat(a.getFullYear(),"-").concat(String(a.getMonth()+1).padStart(2,"0")))}}),(0,r.jsx)("span",{className:"text-lg font-semibold",children:p}),(0,r.jsx)(d,{className:"h-6 w-6 cursor-pointer text-gray-600",onClick:()=>{let[e,t]=p.split("-").map(Number),a=new Date(e,t,1);h("".concat(a.getFullYear(),"-").concat(String(a.getMonth()+1).padStart(2,"0")))}}),(0,r.jsx)("button",{onClick:()=>L(!0),className:"ml-4 px-3 py-1 rounded-full bg-red-500 text-white text-sm shadow-sm hover:bg-red-600 transition",children:"+ Nuevo Gasto"}),(0,r.jsx)("button",{onClick:()=>Y(!0),className:"px-3 py-1 rounded-full bg-green-500 text-white text-sm shadow-sm hover:bg-green-600 transition",children:"+ Nuevo Ingreso"})]}),M&&(0,r.jsx)(s.Z,{onClose:()=>L(!1),onSaved:()=>{L(!1)}}),R&&(0,r.jsx)(u.Z,{onClose:()=>Y(!1),onSaved:()=>{Y(!1)}}),(0,r.jsx)("main",{className:"p-4 grid gap-4 grid-cols-1 sm:grid-cols-2 lg:grid-cols-3"})]})}}},function(e){e.O(0,[590,78,888,774,179],function(){return e(e.s=8312)}),_N_E=e.O()}]);